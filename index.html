<html><head><base href="." />
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MK-CARDIOSPORT Nutri Fit</title>
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: Arial, sans-serif;
    }

    :root {
      --primary-color: #000080; /* Dark blue */
      --secondary-color: #FFD700; /* Yellow */
      --accent-color: #000000; /* Black */
      --text-light: #FFFFFF; /* White */
      --monday-color: #000080;
      --tuesday-color: #000080;
      --wednesday-color: #000080;
      --thursday-color: #000080;
      --friday-color: #FFD700;
      --saturday-color: #000080; /* Saturday color */
      --sunday-color: #000080; /* Sunday color */
    }

    body {
      background: #f5f6fa;
    }

    .header {
      background: var(--primary-color);
      color: var(--secondary-color);
      text-align: center;
      padding: 1rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      position: relative;
      padding-top: 20px;
      display: flex;
      flex-direction: column; /* Changed to column */
      align-items: center;
      justify-content: center;
      gap: 20px;
    }

    .header-logo {
      width: 100px;
      height: auto;
      margin-bottom: 10px; /* Add margin bottom for spacing */
    }

    .header-content {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .header h1 {
      font-family: 'Arial', sans-serif;
      color: var(--secondary-color);
      margin-bottom: 5px;
    }

    .header h2 {
      font-family: 'Arial', sans-serif;
      color: var(--secondary-color);
      margin-bottom: 10px;
      font-size: 1.5em;
    }

    .header p {
      color: var(--text-light);
      font-size: 1.1em;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .accordion {
      margin: 20px 0;
    }

    .accordion-button {
      width: 100%;
      padding: 15px;
      background: white;
      border: none;
      border-radius: 5px;
      margin: 5px 0;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: bold;
      color: var(--primary-color);
      transition: all 0.3s ease;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .day-monday { background-color: var(--monday-color); color: white; }
    .day-tuesday { background-color: var(--tuesday-color); color: white; }
    .day-wednesday { background-color: var(--wednesday-color); color: white; }
    .day-thursday { background-color: var(--thursday-color); color: white; }
    .day-friday { background-color: var(--friday-color); color: var(--primary-color); }
    .day-saturday { background-color: var(--saturday-color); color: white; }
    .day-sunday { background-color: var(--sunday-color); color: white; }

    .editor-container {
      margin: 10px 0;
      background: white;
      border-radius: 4px;
      min-height: 200px;
    }

    .ql-editor {
      min-height: 200px;
      padding: 15px !important;
      background: #f8f9fa !important;
      border-radius: 4px !important;
    }

    .accordion-content {
      padding: 15px;
      background: white;
      border-radius: 5px;
      margin: 5px 0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      display: none;
    }

    .save-btn {
      background: var(--accent-color);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .save-btn:hover {
      background: #2980b9;
    }

    .active {
      background: #f8f9fa;
    }

    .active + .accordion-content {
      display: block;
    }

    #patientLibrary {
      background: white;
      padding: 20px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .filter-container {
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #month-filter {
      padding: 5px;
      border-radius: 4px;
      border: 1px solid #ddd;
    }

    .patient-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .patient-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 16px;
      background: var(--primary-color);
      color: white;
      text-decoration: none;
      border-radius: 4px;
      transition: all 0.3s ease;
    }

    .patient-item:hover {
      background: var(--secondary-color);
      color: var(--primary-color);
    }

    .patient-date {
      color: inherit;
      font-size: 0.9em;
    }

    .form-group {
      display: flex;
      gap: 20px;
      align-items: center;
      margin-bottom: 20px;
    }

    .form-group label {
      color: var(--primary-color);
      font-weight: bold;
    }

    .form-group input {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 1rem;
    }

    #patient-name {
      flex: 2;
    }

    #patient-date {
      flex: 1;
    }

    /* Hover styles for accordion buttons */
    .accordion-button.day-monday:hover,
    .accordion-button.day-tuesday:hover,
    .accordion-button.day-wednesday:hover,
    .accordion-button.day-thursday:hover,
    .accordion-button.day-friday:hover,
    .accordion-button.day-saturday:hover,
    .accordion-button.day-sunday:hover {
      background-color: #f8f9fa !important;
      color: var(--primary-color) !important;
      transform: translateY(-1px);
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    /* Preloader styles */
    .preloader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--primary-color);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.5s ease;
    }

    .preloader.fade-out {
      opacity: 0;
      pointer-events: none;
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 5px solid var(--secondary-color);
      border-top: 5px solid transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }

      .header {
        padding: 1rem;
      }

      .header-logo {
        width: 80px;
      }

      .header h1 {
        font-size: 1.5em;
      }

      .header h2 {
        font-size: 1.2em;
      }

      .patient-info {
        font-size: 1em;
      }

      .accordion-button {
        padding: 12px;
        font-size: 0.9em;
      }

      .accordion-content {
        padding: 10px;
      }

      .ql-editor {
        padding: 10px !important;
        font-size: 0.9em;
      }
    }
  </style>
</head>
<body>
  <div class="preloader">
    <div class="spinner"></div>
  </div>

  <header class="header">
    <img src="/logo.png" alt="CardioSport Logo" class="header-logo">
    <div class="header-content">
      <h1>MK-CARDIOSPORT</h1>
      <h2>NutriFit</h2>
      <p>Siga o seu objetivo!</p>
    </div>
  </header>

  <div class="container">
    <div class="form-group">
      <label for="patient-name">Nome do Paciente:</label>
      <input type="text" id="patient-name" placeholder="Digite o nome do paciente">
      <label for="patient-date">Data:</label>
      <input type="date" id="patient-date">
    </div>

    <div class="accordion">
      <button class="accordion-button">
        Refeições
        <span>+</span>
      </button>
      <div class="accordion-content">
        <div class="accordion">
          <button class="accordion-button day-monday">
            Segunda-feira
            <span>+</span>
          </button>
          <div class="accordion-content">
            <textarea class="meal-textarea" data-day="monday" placeholder="Cole aqui as refeições de Segunda-feira..."></textarea>
            <button class="save-btn">Salvar Segunda-feira</button>
          </div>
        </div>

        <div class="accordion">
          <button class="accordion-button day-tuesday">
            Terça-feira
            <span>+</span>
          </button>
          <div class="accordion-content">
            <textarea class="meal-textarea" data-day="tuesday" placeholder="Cole aqui as refeições de Terça-feira..."></textarea>
            <button class="save-btn">Salvar Terça-feira</button>
          </div>
        </div>

        <div class="accordion">
          <button class="accordion-button day-wednesday">
            Quarta-feira
            <span>+</span>
          </button>
          <div class="accordion-content">
            <textarea class="meal-textarea" data-day="wednesday" placeholder="Cole aqui as refeições de Quarta-feira..."></textarea>
            <button class="save-btn">Salvar Quarta-feira</button>
          </div>
        </div>

        <div class="accordion">
          <button class="accordion-button day-thursday">
            Quinta-feira
            <span>+</span>
          </button>
          <div class="accordion-content">
            <textarea class="meal-textarea" data-day="thursday" placeholder="Cole aqui as refeições de Quinta-feira..."></textarea>
            <button class="save-btn">Salvar Quinta-feira</button>
          </div>
        </div>

        <div class="accordion">
          <button class="accordion-button day-friday">
            Sexta-feira
            <span>+</span>
          </button>
          <div class="accordion-content">
            <textarea class="meal-textarea" data-day="friday" placeholder="Cole aqui as refeições de Sexta-feira..."></textarea>
            <button class="save-btn">Salvar Sexta-feira</button>
          </div>
        </div>

        <div class="accordion">
          <button class="accordion-button day-saturday">
            Sábado
            <span>+</span>
          </button>
          <div class="accordion-content">
            <textarea class="meal-textarea" data-day="saturday" placeholder="Cole aqui as refeições de Sábado..."></textarea>
            <button class="save-btn">Salvar Sábado</button>
          </div>
        </div>

        <div class="accordion">
          <button class="accordion-button day-sunday">
            Domingo
            <span>+</span>
          </button>
          <div class="accordion-content">
            <textarea class="meal-textarea" data-day="sunday" placeholder="Cole aqui as refeições de Domingo..."></textarea>
            <button class="save-btn">Salvar Domingo</button>
          </div>
        </div>
      </div>
    </div>

    <div class="accordion">
      <button class="accordion-button">
        Alternativas
        <span>+</span>
      </button>
      <div class="accordion-content">
        <div class="editor-container">
          <textarea class="meal-textarea" data-field="alternativas" placeholder="Cole aqui as alternativas..."></textarea>
        </div>
        <button class="save-btn">Salvar Alternativas</button>
      </div>
    </div>

    <div class="accordion">
      <button class="accordion-button">
        Metabolismo
        <span>+</span>
      </button>
      <div class="accordion-content">
        <div class="editor-container">
          <textarea class="meal-textarea" data-field="metabolismo" placeholder="Cole aqui as informações do metabolismo..."></textarea>
        </div>
        <button class="save-btn">Salvar Metabolismo</button>
      </div>
    </div>

    <div class="accordion">
      <button class="accordion-button">
        Exercícios
        <span>+</span>
      </button>
      <div class="accordion-content">
        <div class="editor-container">
          <textarea class="meal-textarea" data-field="exercicios" placeholder="Cole aqui o programa de exercícios..."></textarea>
        </div>
        <button class="save-btn">Salvar Exercícios</button>
      </div>
    </div>

    <button id="createPatientPageBtn" class="save-btn" style="margin-top: 20px; background-color: var(--primary-color); width: 100%;">
      Criar Página do Paciente
    </button>

    <div class="accordion">
      <button class="accordion-button">
        Biblioteca de Pacientes
        <span>+</span>
      </button>
      <div class="accordion-content">
        <div class="filter-container">
          <label for="month-filter">Filtrar por mês:</label>
          <select id="month-filter">
            <option value="">Todos</option>
            <option value="01">Janeiro</option>
            <option value="02">Fevereiro</option>
            <option value="03">Março</option>
            <option value="04">Abril</option>
            <option value="05">Maio</option>
            <option value="06">Junho</option>
            <option value="07">Julho</option>
            <option value="08">Agosto</option>
            <option value="09">Setembro</option>
            <option value="10">Outubro</option>
            <option value="11">Novembro</option>
            <option value="12">Dezembro</option>
          </select>
        </div>
        <div id="patientLinks" class="patient-list"></div>
      </div>
    </div>
  </div>

  <script>
    let patientData = JSON.parse(localStorage.getItem('patientData')) || {};

    function handlePreloader() {
      const preloader = document.querySelector('.preloader');
      window.addEventListener('load', () => {
        setTimeout(() => {
          preloader.classList.add('fade-out');
        }, 500);
      });
    }

    function initializeAccordions() {
      document.querySelectorAll('.accordion-content').forEach(content => {
        content.style.display = 'none';
      });

      document.querySelectorAll('.accordion-button').forEach(button => {
        button.classList.remove('active');
        const span = button.querySelector('span');
        if (span) {
          span.textContent = '+';
        }

        button.addEventListener('click', (e) => {
          e.stopPropagation();
          
          const parentContent = button.closest('.accordion-content');
          if (parentContent) {
            const siblings = parentContent.querySelectorAll('.accordion-button.active');
            siblings.forEach(sibling => {
              if (sibling !== button) {
                sibling.classList.remove('active');
                const siblingContent = sibling.nextElementSibling;
                if (siblingContent) siblingContent.style.display = 'none';
                const siblingSpan = sibling.querySelector('span');
                if (siblingSpan) siblingSpan.textContent = '+';
              }
            });
          }

          button.classList.toggle('active');
          const content = button.nextElementSibling;
          if (content) {
            content.style.display = button.classList.contains('active') ? 'block' : 'none';
          }
          
          const span = button.querySelector('span');
          if (span) {
            span.textContent = button.classList.contains('active') ? '-' : '+';
          }
        });
      });
    }

    function addDownloadButton(htmlContent, patientName) {
      const downloadButton = document.createElement('button');
      downloadButton.className = 'download-button';
      downloadButton.textContent = 'Baixar Página';
      
      downloadButton.addEventListener('click', () => {
        const blob = new Blob([htmlContent], { type: 'text/html' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${patientName}_plano_nutricional.html`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
      });

      document.body.appendChild(downloadButton);
    }

    function createPatientPage(patientName) {
      const data = patientData[patientName];
      const newWindow = window.open('', '_blank');

      const viewPageHTML = `
        <html>
        <head>
          <title>${patientName} - Plano Nutricional</title>
          <style>
            :root {
              --primary-color: #000080;
              --secondary-color: #FFD700;
              --accent-color: #000000;
              --text-light: #FFFFFF;
              --monday-color: #000080;
              --tuesday-color: #000080;
              --wednesday-color: #000080;
              --thursday-color: #000080;
              --friday-color: #FFD700;
              --saturday-color: #000080;
              --sunday-color: #000080;
            }

            * {
              margin: 0;
              padding: 0;
              box-sizing: border-box;
              font-family: Arial, sans-serif;
            }

            body {
              background: #f5f6fa;
            }

            .header {
              background: var(--primary-color);
              color: var(--secondary-color);
              text-align: center;
              padding: 1.5rem;
              box-shadow: 0 2px 5px rgba(0,0,0,0.2);
              margin-bottom: 20px;
              position: relative;
              padding-top: 20px; /* Reduced from 120px */
              display: flex;
              flex-direction: column;
              align-items: center;
              justify-content: center;
              gap: 20px;
            }

            .header-logo {
              position: static; /* Remove absolute positioning */
              transform: none; /* Remove transform */
              width: 100px; /* Reduced size */
              height: auto;
              margin-bottom: 0;
            }

            .header-content {
              display: flex;
              flex-direction: column;
              align-items: center;
            }

            .header h1 {
              color: var(--secondary-color);
              margin-bottom: 5px;
            }

            .header h2 {
              color: var(--secondary-color);
              margin-bottom: 10px;
              font-size: 1.5em;
            }

            .container {
              max-width: 1200px;
              margin: 0 auto;
              padding: 20px;
            }

            .accordion-button {
              width: 100%;
              padding: 15px;
              background: white;
              border: none;
              border-radius: 5px;
              margin: 5px 0;
              cursor: pointer;
              display: flex;
              justify-content: space-between;
              align-items: center;
              font-weight: bold;
              color: var(--primary-color);
              transition: all 0.3s ease;
              box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            }

            .day-monday { background-color: var(--monday-color); color: white; }
            .day-tuesday { background-color: var(--tuesday-color); color: white; }
            .day-wednesday { background-color: var(--wednesday-color); color: white; }
            .day-thursday { background-color: var(--thursday-color); color: white; }
            .day-friday { background-color: var(--friday-color); color: var(--primary-color); }
            .day-saturday { background-color: var(--saturday-color); color: white; }
            .day-sunday { background-color: var(--sunday-color); color: white; }

            .accordion-content {
              display: none;
              padding: 15px;
              background: white;
              border-radius: 5px;
              margin: 5px 0;
              box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            }

            .patient-info {
              text-align: center;
              color: var(--text-light);
              margin-top: 15px;
              font-size: 1.2em;
              padding: 10px;
            }

            .patient-info strong {
              color: var(--secondary-color);
              font-size: 1.3em;
              display: block;
              margin-bottom: 5px;
            }

            .ql-toolbar {
              display: none !important;
            }

            .ql-container.ql-snow {
              border: none !important;
            }

            .ql-editor {
              padding: 15px !important;
              background: #f8f9fa !important;
              border-radius: 4px !important;
              min-height: auto !important;
              cursor: default !important;
            }

            .accordion-button:hover {
              transform: translateY(-1px);
              box-shadow: 0 4px 6px rgba(0,0,0,0.1);
              background: #f8f9fa;
            }

            /* Hover styles for accordion buttons */
            .accordion-button.day-monday:hover,
            .accordion-button.day-tuesday:hover,
            .accordion-button.day-wednesday:hover,
            .accordion-button.day-thursday:hover,
            .accordion-button.day-friday:hover,
            .accordion-button.day-saturday:hover,
            .accordion-button.day-sunday:hover {
              background-color: #f8f9fa !important;
              color: var(--primary-color) !important;
              transform: translateY(-1px);
              box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            }

            .active {
              background: #f8f9fa;
            }

            .active + .accordion-content {
              display: block;
            }

            @media (max-width: 768px) {
              .container {
                padding: 10px;
              }

              .header {
                padding: 1rem;
              }

              .header-logo {
                width: 80px;
              }

              .header h1 {
                font-size: 1.5em;
              }

              .header h2 {
                font-size: 1.2em;
              }

              .patient-info {
                font-size: 1em;
              }

              .accordion-button {
                padding: 12px;
                font-size: 0.9em;
              }

              .accordion-content {
                padding: 10px;
              }

              .ql-editor {
                padding: 10px !important;
                font-size: 0.9em;
              }
            }
          </style>
          <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
        </head>
        <body>
          <div class="preloader">
            <div class="spinner"></div>
          </div>
          <header class="header">
            <img src="/logo.png" alt="CardioSport Logo" class="header-logo">
            <div class="header-content">
              <h1>MK-CARDIOSPORT</h1>
              <h2>NutriFit</h2>
              <div class="patient-info">
                <p><strong>${patientName}</strong> - Plano Nutricional</p>
                <p>Data: ${data.date ? new Date(data.date).toLocaleDateString('pt-BR') : 'Data não especificada'}</p>
              </div>
            </div>
          </header>
          
          <div class="container">
            <div class="accordion">
              <button class="accordion-button">
                Refeições
                <span>+</span>
              </button>
              <div class="accordion-content">
                ${['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'].map(day => `
                  <div class="accordion">
                    <button class="accordion-button day-${day}">
                      ${day === 'monday' ? 'Segunda-feira' :
                        day === 'tuesday' ? 'Terça-feira' :
                        day === 'wednesday' ? 'Quarta-feira' :
                        day === 'thursday' ? 'Quinta-feira' :
                        day === 'friday' ? 'Sexta-feira' :
                        day === 'saturday' ? 'Sábado' :
                        'Domingo'}
                      <span>+</span>
                    </button>
                    <div class="accordion-content">
                      <div class="ql-editor">${data.meals[day] || 'Nenhuma refeição registrada'}</div>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>

            <div class="accordion">
              <button class="accordion-button">
                Alternativas
                <span>+</span>
              </button>
              <div class="accordion-content">
                <div class="ql-editor">${data.alternativas || 'Nenhuma alternativa registrada'}</div>
              </div>
            </div>

            <div class="accordion">
              <button class="accordion-button">
                Metabolismo
                <span>+</span>
              </button>
              <div class="accordion-content">
                <div class="ql-editor">${data.metabolismo || 'Nenhuma informação de metabolismo registrada'}</div>
              </div>
            </div>

            <div class="accordion">
              <button class="accordion-button">
                Exercícios
                <span>+</span>
              </button>
              <div class="accordion-content">
                <div class="ql-editor">${data.exercicios || 'Nenhum exercício registrado'}</div>
              </div>
            </div>
          </div>

          <script>
            function handlePreloader() {
              const preloader = document.querySelector('.preloader');
              if (preloader) {
                window.addEventListener('load', () => {
                  setTimeout(() => {
                    preloader.classList.add('fade-out');
                  }, 500);
                });
              }
            }

            function initializeAccordions() {
              const accordionContents = document.querySelectorAll('.accordion-content');
              const accordionButtons = document.querySelectorAll('.accordion-button');
              
              if (accordionContents && accordionButtons) {
                accordionContents.forEach(content => {
                  if (content) {
                    content.style.display = 'none';
                  }
                });

                accordionButtons.forEach(button => {
                  if (button) {
                    button.classList.remove('active');
                    const span = button.querySelector('span');
                    if (span) {
                      span.textContent = '+';
                    }

                    button.addEventListener('click', (e) => {
                      if (e) {
                        e.stopPropagation();
                      }
                      
                      const parentContent = button.closest('.accordion-content');
                      if (parentContent) {
                        const siblings = parentContent.querySelectorAll('.accordion-button.active');
                        siblings.forEach(sibling => {
                          if (sibling && sibling !== button) {
                            sibling.classList.remove('active');
                            const siblingContent = sibling.nextElementSibling;
                            if (siblingContent) {
                              siblingContent.style.display = 'none';
                            }
                            const siblingSpan = sibling.querySelector('span');
                            if (siblingSpan) {
                              siblingSpan.textContent = '+';
                            }
                          }
                        });
                      }

                      button.classList.toggle('active');
                      const content = button.nextElementSibling;
                      if (content) {
                        content.style.display = button.classList.contains('active') ? 'block' : 'none';
                      }
                      
                      const span = button.querySelector('span');
                      if (span) {
                        span.textContent = button.classList.contains('active') ? '-' : '+';
                      }
                    });
                  }
                });
              }
            }

            // Ensure DOM is loaded before running initialization
            if (document.readyState === 'loading') {
              document.addEventListener('DOMContentLoaded', function() {
                handlePreloader();
                initializeAccordions();
              });
            } else {
              handlePreloader();
              initializeAccordions();
            }
          <\/script>
        </body>
        </html>
      `;
      
      newWindow.document.write(viewPageHTML);
      newWindow.document.close();
      
      // Add this after document.close():
      newWindow.onload = function() {
        addDownloadButton(viewPageHTML, patientName);
      };
    }

    document.querySelectorAll('.save-btn').forEach(button => {
      button.addEventListener('click', function() {
        const patientName = document.getElementById('patient-name').value.trim();
        const patientDate = document.getElementById('patient-date').value;
        
        if (!patientName) {
          alert('Por favor, insira o nome do paciente primeiro!');
          return;
        }

        if (!patientData[patientName]) {
          patientData[patientName] = {
            date: patientDate,
            meals: {},
            exercicios: '',
            metabolismo: '',
            alternativas: ''
          };
        }

        const section = this.closest('.accordion-content');
        const inputs = section.querySelectorAll('.patient-data, .meal-textarea');
        let dataUpdated = false;

        inputs.forEach(input => {
          if (input.classList.contains('meal-textarea')) {
            const day = input.dataset.day;
            if (day) {
              patientData[patientName].meals[day] = input.value;
              dataUpdated = true;
            } else if (input.dataset.field === 'exercicios') {
              patientData[patientName].exercicios = input.value;
              dataUpdated = true;
            } else if (input.dataset.field === 'metabolismo') {
              patientData[patientName].metabolismo = input.value;
              dataUpdated = true;
            } else if (input.dataset.field === 'alternativas') {
              patientData[patientName].alternativas = input.value;
              dataUpdated = true;
            }
          } 
        });

        if (dataUpdated) {
          localStorage.setItem('patientData', JSON.stringify(patientData));
          button.textContent = 'Salvo!';
          button.style.backgroundColor = '#27ae60';
          setTimeout(() => {
            button.textContent = 'Salvar';
            button.style.backgroundColor = '';
          }, 2000);
        }
      });
    });

    document.getElementById('createPatientPageBtn').addEventListener('click', function() {
      const patientName = document.getElementById('patient-name').value.trim();
      
      if (!patientName) {
        alert('Por favor, insira o nome do paciente primeiro!');
        return;
      }

      if (!patientData[patientName]) {
        alert('Por favor, salve algum dado do paciente primeiro!');
        return;
      }

      createPatientPage(patientName);
      updatePatientLibrary();
    });

    function updatePatientLibrary() {
      const patientLinks = document.getElementById('patientLinks');
      const monthFilter = document.getElementById('month-filter');
      
      function renderPatients(filterMonth = '') {
        patientLinks.innerHTML = '';
        
        const patients = Object.entries(patientData)
          .sort((a, b) => {
            const dateA = new Date(a[1].date || '1900-01-01');
            const dateB = new Date(b[1].date || '1900-01-01');
            return dateB - dateA;
          })
          .filter(([_, data]) => {
            if (!filterMonth) return true;
            const patientMonth = data.date ? data.date.split('-')[1] : '';
            return patientMonth === filterMonth;
          });

        patients.forEach(([patientName, data]) => {
          const itemDiv = document.createElement('div');
          itemDiv.className = 'patient-item';
          
          const nameSpan = document.createElement('span');
          nameSpan.textContent = patientName;
          
          const dateSpan = document.createElement('span');
          dateSpan.className = 'patient-date';
          dateSpan.textContent = data.date ? new Date(data.date).toLocaleDateString('pt-BR') : 'Sem data';
          
          itemDiv.appendChild(nameSpan);
          itemDiv.appendChild(dateSpan);
          
          itemDiv.addEventListener('click', () => {
            createPatientPage(patientName);
          });
          
          patientLinks.appendChild(itemDiv);
        });
      }

      monthFilter.addEventListener('change', (e) => {
        renderPatients(e.target.value);
      });

      renderPatients();
    }

    document.addEventListener('DOMContentLoaded', function() {
      handlePreloader();
      initializeAccordions();
      initializeEditors();
      updatePatientLibrary();
    });
  </script>
</body></html>
