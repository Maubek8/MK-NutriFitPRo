<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MK-NutriFit</title>
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, getDocs, collection } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

    // Configuração do Firebase
    const firebaseConfig = {
      apiKey: "SUA_CHAVE_DE_API",
      authDomain: "mk-nutrifit.firebaseapp.com",
      projectId: "mk-nutrifit",
      storageBucket: "mk-nutrifit.appspot.com",
      messagingSenderId: "596494427405",
      appId: "1:596494427405:web:de194c97f24cd9d51e3c44",
      measurementId: "G-HG6TGC3064",
    };

    // Inicializar Firebase e Firestore
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
  </script>
  <style>
    /* Insira aqui o CSS original do seu layout */
  </style>
</head>
<body>
  <!-- Layout da Página -->
<script type="module">
  const saveDataToFirestore = async (patientName, patientData) => {
    try {
      await setDoc(doc(db, "patients", patientName), patientData);
      console.log("Dados salvos com sucesso no Firebase!");
    } catch (error) {
      console.error("Erro ao salvar dados no Firestore:", error);
    }
  };

  const getDataFromFirestore = async (patientName) => {
    try {
      const docRef = doc(db, "patients", patientName);
      const docSnap = await getDoc(docRef);

      if (docSnap.exists()) {
        return docSnap.data();
      } else {
        console.warn("Paciente não encontrado!");
        return null;
      }
    } catch (error) {
      console.error("Erro ao buscar dados no Firestore:", error);
    }
  };

  const getAllPatientsFromFirestore = async () => {
    try {
      const querySnapshot = await getDocs(collection(db, "patients"));
      const patients = [];
      querySnapshot.forEach((doc) => {
        patients.push({ id: doc.id, ...doc.data() });
      });
      return patients;
    } catch (error) {
      console.error("Erro ao buscar pacientes:", error);
    }
  };
</script>
<script type="module">
  // Salvar dados do paciente ao clicar no botão "Salvar"
  document.querySelectorAll(".save-btn").forEach((button) => {
    button.addEventListener("click", async () => {
      const patientName = document.getElementById("patient-name").value.trim();
      const patientDate = document.getElementById("patient-date").value;
      const section = button.closest(".accordion-content");
      const inputs = section.querySelectorAll(".meal-textarea");

      if (!patientName || !patientDate) {
        alert("Por favor, preencha o nome e a data do paciente!");
        return;
      }

      const patientData = await getDataFromFirestore(patientName) || { name: patientName, date: patientDate, meals: {} };
      inputs.forEach((input) => {
        if (input.dataset.field) {
          patientData[input.dataset.field] = input.value;
        }
      });

      await saveDataToFirestore(patientName, patientData);
      alert("Dados salvos com sucesso!");
    });
  });

  // Criar página do paciente
  document.getElementById("createPatientPageBtn").addEventListener("click", async () => {
    const patientName = document.getElementById("patient-name").value.trim();
    const patientData = await getDataFromFirestore(patientName);

    if (!patientData) {
      alert("Paciente não encontrado!");
      return;
    }

    const newWindow = window.open("", "_blank");
    newWindow.document.write(`
      <html>
      <head>
        <title>${patientData.name} - Dados</title>
        <style>
          body {
            font-family: Arial, sans-serif;
            background: #f5f6fa;
            text-align: center;
            padding: 20px;
          }
          .header {
            background: #000080;
            color: #FFD700;
            padding: 20px;
          }
          .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px auto;
            max-width: 600px;
          }
        </style>
      </head>
      <body>
        <header class="header">
          <h1>${patientData.name}</h1>
        </header>
        <div class="container">
          <p><strong>Data:</strong> ${patientData.date}</p>
          <p><strong>Metabolismo:</strong> ${patientData.metabolismo || "Não especificado"}</p>
          <p><strong>Exercícios:</strong> ${patientData.exercicios || "Não especificado"}</p>
        </div>
      </body>
      </html>
    `);
    newWindow.document.close();
  });

  // Atualizar biblioteca de pacientes
  const updatePatientLibrary = async () => {
    const patients = await getAllPatientsFromFirestore();
    const libraryDiv = document.getElementById("patientLinks");

    libraryDiv.innerHTML = "";
    patients.forEach((patient) => {
      const patientDiv = document.createElement("div");
      patientDiv.className = "patient-item";
      patientDiv.innerHTML = `
        <span>${patient.name}</span>
        <span>${new Date(patient.date).toLocaleDateString("pt-BR")}</span>
      `;
      libraryDiv.appendChild(patientDiv);
    });
  };

  document.addEventListener("DOMContentLoaded", updatePatientLibrary);
</script>
